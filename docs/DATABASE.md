# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –¥–ª—è MakarovFlow

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–±–ª–∞—á–Ω—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö.

## üìå –¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è

**–°–µ–π—á–∞—Å:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (IndexedDB —á–µ—Ä–µ–∑ Dexie.js)

**–ü—Ä–æ–±–ª–µ–º—ã:**
- ‚ùå –î–∞–Ω–Ω—ã–µ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
- ‚ùå –ü—Ä–∏ –ø–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∫–µ Telegram –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è
- ‚ùå –ù–µ–≤–æ–∑–º–æ–∂–µ–Ω –¥–æ—Å—Ç—É–ø —Å –¥—Ä—É–≥–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚ùå –ù–µ—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

## ‚òÅÔ∏è –†–µ—à–µ–Ω–∏–µ: –û–±–ª–∞—á–Ω–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Å—Ç–µ–∫:

1. **Supabase** (PostgreSQL + REST API + Auth)
2. **Backend –Ω–∞ Render.com** (Node.js + Express)
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è** –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω—ã–º IndexedDB –∏ –æ–±–ª–∞–∫–æ–º

## üöÄ –í–∞—Ä–∏–∞–Ω—Ç 1: Supabase (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

**Supabase** - Firebase –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ —Å PostgreSQL, –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω –¥–æ 500 MB.

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- ‚úÖ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–æ 500 MB
- ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è
- ‚úÖ Realtime –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ REST API –∏–∑ –∫–æ—Ä–æ–±–∫–∏
- ‚úÖ Dashboard –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –±—ç–∫–∞–ø—ã

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞:

#### 1. –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ Supabase

```bash
# –ó–∞–π—Ç–∏ –Ω–∞ https://supabase.com
# –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
# –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç
# –ü–æ–ª—É—á–∏—Ç—å API URL –∏ API Key
```

#### 2. –°–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã

```sql
-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  telegram_id BIGINT UNIQUE NOT NULL,
  username TEXT,
  first_name TEXT,
  is_premium BOOLEAN DEFAULT FALSE,
  premium_until TIMESTAMP,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–ø–∏—Å–µ–π –¥–Ω–µ–≤–Ω–∏–∫–∞
CREATE TABLE journal_entries (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  mood TEXT NOT NULL,
  mood_emoji TEXT NOT NULL,
  energy INTEGER,
  sleep_hours DECIMAL,
  sleep_quality INTEGER,
  tags TEXT[],
  note TEXT,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(user_id, date)
);

-- –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
CREATE TABLE schedule (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  subject TEXT NOT NULL,
  day_of_week INTEGER NOT NULL,
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  room TEXT,
  color TEXT,
  recurring BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- –¢–∞–±–ª–∏—Ü–∞ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π
CREATE TABLE homework (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  subject TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  due_date DATE NOT NULL,
  completed BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT NOW()
);

-- –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –ø–æ–∏—Å–∫–∞
CREATE INDEX idx_journal_user_date ON journal_entries(user_id, date DESC);
CREATE INDEX idx_schedule_user_day ON schedule(user_id, day_of_week);
CREATE INDEX idx_homework_user_date ON homework(user_id, due_date);

-- Row Level Security (RLS)
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE journal_entries ENABLE ROW LEVEL SECURITY;
ALTER TABLE schedule ENABLE ROW LEVEL SECURITY;
ALTER TABLE homework ENABLE ROW LEVEL SECURITY;
```

#### 3. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Supabase Client

```bash
npm install @supabase/supabase-js
```

#### 4. –°–æ–∑–¥–∞—Ç—å Supabase –∫–ª–∏–µ–Ω—Ç

–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª `src/lib/supabase.js`:

```javascript
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

export const supabase = createClient(supabaseUrl, supabaseAnonKey);

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export async function initUser(telegramUser) {
  const { data, error } = await supabase
    .from('users')
    .upsert({
      telegram_id: telegramUser.id,
      username: telegramUser.username,
      first_name: telegramUser.first_name
    }, {
      onConflict: 'telegram_id'
    })
    .select()
    .single();

  if (error) throw error;
  return data;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –¥–Ω–µ–≤–Ω–∏–∫–∞
export async function saveJournalEntry(userId, entry) {
  const { data, error } = await supabase
    .from('journal_entries')
    .upsert({
      user_id: userId,
      ...entry
    }, {
      onConflict: 'user_id,date'
    })
    .select()
    .single();

  if (error) throw error;
  return data;
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –∑–∞–ø–∏—Å–µ–π
export async function getJournalEntries(userId, limit = 30) {
  const { data, error } = await supabase
    .from('journal_entries')
    .select('*')
    .eq('user_id', userId)
    .order('date', { ascending: false })
    .limit(limit);

  if (error) throw error;
  return data;
}
```

#### 5. –û–±–Ω–æ–≤–∏—Ç—å .env —Ñ–∞–π–ª

```bash
VITE_SUPABASE_URL=your-project-url.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key
```

## üîÑ –í–∞—Ä–∏–∞–Ω—Ç 2: Render + PostgreSQL

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞:

1. **–°–æ–∑–¥–∞—Ç—å PostgreSQL –±–∞–∑—É –Ω–∞ Render.com**
   - –ó–∞–π—Ç–∏ –Ω–∞ https://render.com
   - –ù–∞–∂–∞—Ç—å "New +" ‚Üí "PostgreSQL"
   - –í—ã–±—Ä–∞—Ç—å Free –ø–ª–∞–Ω
   - –°–æ–∑–¥–∞—Ç—å –±–∞–∑—É

2. **–°–æ–∑–¥–∞—Ç—å Express Backend**

```javascript
// server.js
import express from 'express';
import pg from 'pg';
import cors from 'cors';

const app = express();
app.use(cors());
app.use(express.json());

const pool = new pg.Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false }
});

// API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
app.post('/api/journal', async (req, res) => {
  const { userId, entry } = req.body;

  try {
    const result = await pool.query(
      `INSERT INTO journal_entries (user_id, date, mood, mood_emoji, energy, sleep_hours, sleep_quality, tags, note)
       VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9)
       ON CONFLICT (user_id, date) DO UPDATE SET
         mood = EXCLUDED.mood,
         mood_emoji = EXCLUDED.mood_emoji,
         energy = EXCLUDED.energy,
         sleep_hours = EXCLUDED.sleep_hours,
         sleep_quality = EXCLUDED.sleep_quality,
         tags = EXCLUDED.tags,
         note = EXCLUDED.note,
         updated_at = NOW()
       RETURNING *`,
      [userId, entry.date, entry.mood, entry.moodEmoji, entry.energy, entry.sleepHours, entry.sleepQuality, entry.tags, entry.note]
    );

    res.json(result.rows[0]);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.get('/api/journal/:userId', async (req, res) => {
  const { userId } = req.params;

  try {
    const result = await pool.query(
      'SELECT * FROM journal_entries WHERE user_id = $1 ORDER BY date DESC LIMIT 30',
      [userId]
    );
    res.json(result.rows);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.listen(3000, () => {
  console.log('Server running on port 3000');
});
```

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram

```javascript
import crypto from 'crypto';

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram WebApp
function verifyTelegramWebAppData(telegramInitData, botToken) {
  const initData = new URLSearchParams(telegramInitData);
  const hash = initData.get('hash');
  initData.delete('hash');

  const dataCheckString = Array.from(initData.entries())
    .sort(([a], [b]) => a.localeCompare(b))
    .map(([key, value]) => `${key}=${value}`)
    .join('\n');

  const secretKey = crypto
    .createHmac('sha256', 'WebAppData')
    .update(botToken)
    .digest();

  const calculatedHash = crypto
    .createHmac('sha256', secretKey)
    .update(dataCheckString)
    .digest('hex');

  return calculatedHash === hash;
}
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö

### Supabase Dashboard:
1. –ó–∞–π—Ç–∏ –Ω–∞ https://app.supabase.com
2. –í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
3. Table Editor - –ø—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
4. SQL Editor - –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–æ–≤

### –ü–æ–ª–µ–∑–Ω—ã–µ SQL –∑–∞–ø—Ä–æ—Å—ã:

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT * FROM users ORDER BY created_at DESC;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–ø–∏—Å–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
SELECT * FROM journal_entries WHERE user_id = 'USER_ID' ORDER BY date DESC;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –ø–æ –¥–Ω—è–º
SELECT date, COUNT(*) as entries
FROM journal_entries
GROUP BY date
ORDER BY date DESC;

-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å Premium –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
SELECT * FROM users WHERE is_premium = TRUE;
```

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ IndexedDB –≤ Supabase:

```javascript
async function migrateToCloud() {
  const localEntries = await journalEntries.getAll();

  for (const entry of localEntries) {
    await saveJournalEntry(userId, entry);
  }

  console.log(`‚úÖ Migrated ${localEntries.length} entries to cloud`);
}
```

## üìù TODO:

- [ ] –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–µ–∫—Ç –Ω–∞ Supabase
- [ ] –°–æ–∑–¥–∞—Ç—å –≤—Å–µ —Ç–∞–±–ª–∏—Ü—ã
- [ ] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Supabase Client
- [ ] –°–æ–∑–¥–∞—Ç—å API wrapper
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
- [ ] –î–æ–±–∞–≤–∏—Ç—å offline-first –ø–æ–¥—Ö–æ–¥
- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- [ ] –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞:

- Supabase Docs: https://supabase.com/docs
- Postgres Tutorial: https://www.postgresql.org/docs/
- Render.com: https://render.com/docs
